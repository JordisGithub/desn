name: Deploy to AWS

on:
  push:
    branches:
      - master

jobs:
  pre-deployment-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:a11y

      - name: Build application
        run: npm run build
        env:
          VITE_API_BASE_URL: "https://desnepal.com"

      - name: Serve application for testing
        run: |
          npm install -g serve a11y-mcp
          serve -s dist -l 3000 &
          sleep 5

      - name: Pre-deployment accessibility audit
        id: pre-deploy-audit
        run: |
          mkdir -p pre-deploy-audit

          # Audit critical pages with a11y-mcp
          echo "Running pre-deployment accessibility audit..."
          npx a11y-mcp audit http://localhost:3000 --tags wcag2a,wcag2aa,wcag22aa > pre-deploy-audit/home.json
          npx a11y-mcp audit http://localhost:3000/about --tags wcag2a,wcag2aa,wcag22aa > pre-deploy-audit/about.json
          npx a11y-mcp audit http://localhost:3000/events --tags wcag2a,wcag2aa,wcag22aa > pre-deploy-audit/events.json

          # Count critical violations
          critical_count=0
          for file in pre-deploy-audit/*.json; do
            if [ -f "$file" ]; then
              critical=$(grep -c '"impact":"critical"' "$file" || echo "0")
              critical_count=$((critical_count + critical))
            fi
          done

          echo "critical_count=$critical_count" >> $GITHUB_OUTPUT

          if [ "$critical_count" -gt "0" ]; then
            echo "âŒ Found $critical_count critical accessibility issues!"
            echo "Deployment blocked. Please fix critical issues before deploying."
            exit 1
          fi

          echo "âœ… No critical accessibility issues found. Deployment approved."

      - name: Upload pre-deployment audit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-deployment-audit
          path: pre-deploy-audit/
          retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    # Required secrets: SSH_PRIVATE_KEY, SERVER_HOST, SERVER_USER
    # Configure these in Repository Settings > Secrets and variables > Actions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        env:
          # Point frontend API calls to production HTTPS endpoint
          VITE_API_BASE_URL: "https://desnepal.com"
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Deploy to AWS Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # Create deployment directory on server
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "mkdir -p /home/ubuntu/desn-app/{frontend,backend,logs,data}"

          # Copy frontend build
          scp -i ~/.ssh/deploy_key -r dist/* $SERVER_USER@$SERVER_HOST:/home/ubuntu/desn-app/frontend/

          # Copy backend JAR (detect non-original jar)
          JAR_FILE=$(ls backend/target/*.jar | grep -v "original" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "No backend jar found in backend/target" >&2
            exit 1
          fi
          scp -i ~/.ssh/deploy_key "$JAR_FILE" $SERVER_USER@$SERVER_HOST:/home/ubuntu/desn-app/backend/app.jar

          # Create environment file on server with production settings
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "cat > /home/ubuntu/desn-app/backend/.env" <<ENVFILE
          CORS_ALLOWED_ORIGINS=https://desnepal.com,https://www.desnepal.com,http://${SERVER_HOST}
          EMAIL_NOTIFICATIONS_ENABLED=false
          ENVFILE

          # Copy deployment script
          scp -i ~/.ssh/deploy_key scripts/deploy-server.sh $SERVER_USER@$SERVER_HOST:/home/ubuntu/desn-app/

          # Execute deployment script on server
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "bash /home/ubuntu/desn-app/deploy-server.sh"

      - name: Verify deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Wait for services to start
          sleep 10

          # Check if backend is running
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "curl -f http://localhost:8080/actuator/health || exit 1"

          echo "âœ… Deployment successful!"
          echo "ğŸŒ Frontend: http://$SERVER_HOST"
          echo "ğŸ”§ Backend: http://$SERVER_HOST/api"
