name: Deploy to AWS

on:
  push:
    branches:
      - master

jobs:
  pre-deployment-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:a11y

      - name: Build application
        run: npm run build
        env:
          VITE_API_BASE_URL: "https://desnepal.com"

      - name: Serve application for testing
        run: |
          npm install -g serve a11y-mcp
          serve -s dist -l 3000 &
          sleep 5

      - name: Pre-deployment accessibility audit
        id: pre-deploy-audit
        run: |
          mkdir -p pre-deploy-audit

          # Audit critical pages with a11y-mcp
          echo "Running pre-deployment accessibility audit..."
          npx a11y-mcp audit http://localhost:3000 --tags wcag2a,wcag2aa,wcag22aa > pre-deploy-audit/home.json
          npx a11y-mcp audit http://localhost:3000/about --tags wcag2a,wcag2aa,wcag22aa > pre-deploy-audit/about.json
          npx a11y-mcp audit http://localhost:3000/events --tags wcag2a,wcag2aa,wcag22aa > pre-deploy-audit/events.json

          # Count critical violations
          critical_count=0
          for file in pre-deploy-audit/*.json; do
            if [ -f "$file" ]; then
              critical=$(grep -c '"impact":"critical"' "$file" || echo "0")
              critical_count=$((critical_count + critical))
            fi
          done

          echo "critical_count=$critical_count" >> $GITHUB_OUTPUT

          if [ "$critical_count" -gt "0" ]; then
            echo "‚ùå Found $critical_count critical accessibility issues!"
            echo "Deployment blocked. Please fix critical issues before deploying."
            exit 1
          fi

          echo "‚úÖ No critical accessibility issues found. Deployment approved."

      - name: Upload pre-deployment audit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-deployment-audit
          path: pre-deploy-audit/
          retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    # Required secrets: SSH_PRIVATE_KEY, SERVER_HOST, SERVER_USER
    # Configure these in Repository Settings > Secrets and variables > Actions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        env:
          # Point frontend API calls to production HTTPS endpoint
          VITE_API_BASE_URL: "https://desnepal.com"
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: mvn clean package -DskipTests

      - name: Deploy to AWS Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          set -e

          # Setup SSH
          echo "üì° Setting up SSH connection..."

          # Verify secrets are set
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "‚ùå SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$SERVER_HOST" ]; then
            echo "‚ùå SERVER_HOST secret is not set"
            exit 1
          fi
          if [ -z "$SERVER_USER" ]; then
            echo "‚ùå SERVER_USER secret is not set"
            exit 1
          fi

          echo "Creating SSH directory..."
          mkdir -p ~/.ssh

          echo "Writing SSH key..."
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key || {
            echo "‚ùå Failed to write SSH key"
            exit 1
          }

          echo "Setting SSH key permissions..."
          chmod 600 ~/.ssh/deploy_key

          echo "Adding server to known hosts..."
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ùå Failed to add server to known hosts"
            echo "Please verify SERVER_HOST is correct"
            exit 1
          }

          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 $SERVER_USER@$SERVER_HOST "echo 'SSH connection successful'" || {
            echo "‚ùå Failed to connect to server"
            echo "Please verify:"
            echo "  - SSH_PRIVATE_KEY is correct and properly formatted"
            echo "  - SERVER_USER has access to the server"
            echo "  - SERVER_HOST is reachable"
            echo "  - The SSH key is authorized on the server"
            exit 1
          }

          echo "‚úÖ SSH setup complete"

          # Create deployment directory on server
          echo "üìÅ Creating deployment directories on server..."
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "mkdir -p /home/$SERVER_USER/desn-app/{frontend,backend,logs,data}" || {
            echo "‚ùå Failed to create directories on server"
            exit 1
          }
          echo "‚úÖ Directories created"

          # Copy frontend build
          echo "üì§ Copying frontend build..."
          if [ ! -d "dist" ]; then
            echo "‚ùå dist directory not found!"
            exit 1
          fi
          scp -i ~/.ssh/deploy_key -r dist/* $SERVER_USER@$SERVER_HOST:/home/$SERVER_USER/desn-app/frontend/ || {
            echo "‚ùå Failed to copy frontend files"
            exit 1
          }
          echo "‚úÖ Frontend copied"

          # Copy backend JAR (detect non-original jar)
          echo "üì§ Copying backend JAR..."
          JAR_FILE=$(ls backend/target/*.jar | grep -v "original" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå No backend jar found in backend/target"
            ls -la backend/target/ || echo "backend/target directory not found"
            exit 1
          fi
          echo "Found JAR: $JAR_FILE"
          scp -i ~/.ssh/deploy_key "$JAR_FILE" $SERVER_USER@$SERVER_HOST:/home/$SERVER_USER/desn-app/backend/app.jar || {
            echo "‚ùå Failed to copy backend JAR"
            exit 1
          }
          echo "‚úÖ Backend JAR copied"

          # Create environment file on server with production settings
          echo "‚öôÔ∏è Creating environment file..."
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "cat > /home/$SERVER_USER/desn-app/backend/.env" <<ENVFILE
          CORS_ALLOWED_ORIGINS=https://desnepal.com,https://www.desnepal.com,http://${SERVER_HOST}
          EMAIL_NOTIFICATIONS_ENABLED=false
          ENVFILE
          echo "‚úÖ Environment file created"

          # Copy deployment script
          echo "üì§ Copying deployment script..."
          scp -i ~/.ssh/deploy_key scripts/deploy-server.sh $SERVER_USER@$SERVER_HOST:/home/$SERVER_USER/desn-app/ || {
            echo "‚ùå Failed to copy deployment script"
            exit 1
          }
          echo "‚úÖ Deployment script copied"

          # Execute deployment script on server
          echo "üöÄ Executing deployment script on server..."
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "SERVER_USER=$SERVER_USER bash /home/$SERVER_USER/desn-app/deploy-server.sh" || {
            echo "‚ùå Deployment script failed on server"
            echo "üìã Fetching server logs..."
            ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "tail -50 /home/$SERVER_USER/desn-app/logs/backend-error.log 2>/dev/null || echo 'No error log found'"
            exit 1
          }
          echo "‚úÖ Deployment completed successfully"

      - name: Verify deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Wait for services to start
          sleep 10

          # Check if backend is running
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "curl -f http://localhost:8080/actuator/health || exit 1"

          echo "‚úÖ Deployment successful!"
          echo "üåê Frontend: http://$SERVER_HOST"
          echo "üîß Backend: http://$SERVER_HOST/api"
