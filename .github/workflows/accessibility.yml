name: Accessibility Testing

on:
  push:
    branches:
      - master
      - feature/*
  pull_request:
    branches:
      - master

jobs:
  accessibility-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:a11y

      - name: Generate accessibility report
        if: always()
        run: |
          echo "## Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/accessibility-report.txt" ]; then
            cat coverage/accessibility-report.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All accessibility tests passed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-test-results
          path: |
            coverage/
            test-results/
          retention-days: 30

  lighthouse-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_API_BASE_URL: "http://localhost:8080"

      - name: Serve application
        run: |
          npm install -g serve
          serve -s dist -l 3000 &
          sleep 5

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/about
            http://localhost:3000/programs
            http://localhost:3000/events
            http://localhost:3000/get-involved
            http://localhost:3000/resources
            http://localhost:3000/contact
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Comment PR with Lighthouse results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            let comment = '## âš¡ Lighthouse Accessibility Audit\n\n';

            try {
              if (fs.existsSync('./.lighthouseci/manifest.json')) {
                const results = JSON.parse(fs.readFileSync('./.lighthouseci/manifest.json', 'utf8'));
                if (results && results.length > 0 && results[0].url) {
                  comment += `ğŸ“Š Results are available at: ${results[0].url}\n\n`;
                  comment += `âœ… Lighthouse CI scan completed successfully for ${results.length} page(s).`;
                } else {
                  comment += 'âœ… Lighthouse CI scan completed successfully.';
                }
              } else {
                comment += 'âœ… Lighthouse CI scan completed. Check the workflow artifacts for detailed results.';
              }
            } catch (error) {
              comment += 'âš ï¸ Lighthouse CI scan completed, but results could not be parsed. Check the workflow artifacts for detailed results.';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
